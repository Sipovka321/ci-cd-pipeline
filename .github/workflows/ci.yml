name: CI Pipeline

on:
  push:
    paths:
      - 'index.html'
  pull_request:

jobs:
  test-nginx:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Test Nginx container
      run: |
        # –ó–∞–ø—É—Å–∫–∞–µ–º nginx –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        docker run -d --name nginx-test -p 9889:80 -v $(pwd):/usr/share/nginx/html nginx:alpine
        echo "Waiting for nginx to start..."
        sleep 5
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º HTTP response code
        echo "Testing HTTP response..."
        response_code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:9889)
        echo "HTTP Response Code: $response_code"
        
        if [ "$response_code" != "200" ]; then
          echo "‚ùå ERROR: Expected HTTP 200, got $response_code"
          exit 1
        fi
        
        # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º MD5 sums
        echo "Comparing MD5 checksums..."
        local_md5=$(md5sum index.html | awk '{print $1}')
        remote_md5=$(curl -s http://localhost:9889 | md5sum | awk '{print $1}')
        echo "Local MD5: $local_md5"
        echo "Remote MD5: $remote_md5"
        
        if [ "$local_md5" != "$remote_md5" ]; then
          echo "‚ùå ERROR: MD5 sums don't match!"
          exit 1
        fi
        
        echo "‚úÖ All tests passed!"

    - name: Cleanup containers
      if: always()
      run: |
        echo "Cleaning up containers..."
        docker stop nginx-test || true
        docker rm nginx-test || true

    - name: Notify Telegram on success
      if: success()
      run: |
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d text="‚úÖ CI Pipeline Success!%0A%0Aüì¶ Repo: ${{ github.repository }}%0Aüîó Commit: ${{ github.sha }}%0Aüåê By: ${{ github.actor }}"

    - name: Notify Telegram on failure
      if: failure()
      run: |
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d text="‚ùå CI Pipeline Failed!%0A%0Aüì¶ Repo: ${{ github.repository }}%0Aüîó Commit: ${{ github.sha }}%0Aüë§ By: ${{ github.actor }}%0A%0Aüìã Check logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
