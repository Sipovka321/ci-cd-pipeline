stages:
  - test

variables:
  CONTAINER_NAME: "nginx-test-$CI_PIPELINE_ID"
  HOST_PORT: 9889
  NGINX_VERSION: "alpine"

test_nginx:
  stage: test
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - apk add --no-cache curl
  script:
    # Запускаем контейнер
    - docker run -d --name $CONTAINER_NAME -p $HOST_PORT:80 -v $(pwd):/usr/share/nginx/html nginx:$NGINX_VERSION
    - sleep 5
    
    # Проверяем код ответа
    - |
      response_code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:$HOST_PORT)
      echo "Response code: $response_code"
      if [ "$response_code" != "200" ]; then
        echo "ERROR: Expected 200, got $response_code"
        exit 1
      fi
    
    # Сравниваем MD5 суммы
    - |
      local_md5=$(md5sum index.html | awk '{print $1}')
      remote_md5=$(curl -s http://localhost:$HOST_PORT | md5sum | awk '{print $1}')
      echo "Local MD5: $local_md5"
      echo "Remote MD5: $remote_md5"
      
      if [ "$local_md5" != "$remote_md5" ]; then
        echo "ERROR: MD5 sums don't match!"
        exit 1
      fi
    
    - echo "All tests passed successfully!"
  after_script:
    - docker stop $CONTAINER_NAME || true
    - docker rm $CONTAINER_NAME || true
  only:
    changes:
      - index.html
